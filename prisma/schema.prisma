generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum DbType {
  POSTGRES
  MYSQL
}

enum ConnectionStatus {
  ACTIVE
  INACTIVE
  ERROR
  TESTING
}

enum SuggestionType {
  INDEX_OPTIMIZATION
  QUERY_OPTIMIZATION
  SCHEMA_OPTIMIZATION
  CONNECTION_OPTIMIZATION
}

enum SuggestionPriority {
  HIGH
  MEDIUM
  LOW
}

enum SuggestionStatus {
  NEW
  REVIEWED
  APPLIED
  DISMISSED
}

model User {
  id           String   @id
  email        String
  name         String?
  passwordHash String?  // For basic auth fallback, hashed with bcrypt
  createdAt    DateTime @default(now())

  optimizationSuggestions OptimizationSuggestion[]
  organizations           OrganizationUser[]
 
  @@index([email])
}

model Organization {
  id          String             @id
  name        String
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  connections Connection[]
  users       OrganizationUser[]
}

model OrganizationUser {
  organizationId String
  userId         String
  role           String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([organizationId, userId])
  @@index([userId])
}

model Connection {
  id                     String           @id @default(cuid())
  organizationId         String
  name                   String
  dbType                 DbType
  host                   String
  port                   Int
  database               String
  username               String
  encryptedPassword      String
  encryptionKeyId        String
  pollingIntervalMinutes Int              @default(1440)
  status                 ConnectionStatus @default(TESTING)
  lastSyncedAt           DateTime?
  createdAt              DateTime         @default(now())
  updatedAt              DateTime         @updatedAt

  organization            Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  queries                 Query[]
  tableAccessPatterns     TableAccessPattern[]
  indexUsage              IndexUsage[]
  optimizationSuggestions OptimizationSuggestion[]
  schemaSnapshots         SchemaSnapshot[]

  @@index([organizationId])
  @@index([status])
  @@index([lastSyncedAt])
}

model Query {
  id           String   @id @default(cuid())
  connectionId String
  queryHash    String
  queryText    String   @db.Text
  firstSeenAt  DateTime @default(now())
  lastSeenAt   DateTime @updatedAt

  connection  Connection               @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  stats       QueryStats[]
  plans       QueryPlan[]
  suggestions OptimizationSuggestion[]

  @@unique([connectionId, queryHash])
  @@index([connectionId])
}

model QueryStats {
  id                   String   @id @default(cuid())
  queryId              String
  capturedAt           DateTime @default(now())
  executionCount       BigInt
  totalExecutionTimeMs Float

  query Query @relation(fields: [queryId], references: [id], onDelete: Cascade)

  @@index([queryId, capturedAt])
}

model QueryPlan {
  id           String   @id @default(cuid())
  queryId      String
  planJson     Json
  costEstimate Float?
  createdAt    DateTime @default(now())

  query Query @relation(fields: [queryId], references: [id], onDelete: Cascade)

  @@index([queryId])
  @@index([createdAt])
}

model TableAccessPattern {
  id             String    @id @default(cuid())
  connectionId   String
  tableName      String
  accessCount    BigInt    @default(0)
  lastAccessedAt DateTime?

  connection Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@unique([connectionId, tableName])
  @@index([connectionId, accessCount])
  @@index([connectionId, lastAccessedAt])
}

model IndexUsage {
  id            String   @id @default(cuid())
  connectionId  String
  tableName     String
  indexName     String
  scans         BigInt   @default(0)
  tuplesRead    BigInt   @default(0)
  tuplesFetched BigInt   @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  connection Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@unique([connectionId, tableName, indexName])
  @@index([connectionId, scans])
}

model OptimizationSuggestion {
  id             String             @id @default(cuid())
  connectionId   String
  userId         String
  queryId        String?
  suggestionText String             @db.Text
  suggestionType SuggestionType
  priority       SuggestionPriority
  status         SuggestionStatus   @default(NEW)
  createdAt      DateTime           @default(now())
  appliedAt      DateTime?

  connection Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  query      Query?     @relation(fields: [queryId], references: [id], onDelete: SetNull)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([connectionId, status])
  @@index([connectionId, priority])
  @@index([connectionId, createdAt])
  @@index([userId])
}

model SchemaSnapshot {
  id           String   @id @default(cuid())
  connectionId String
  capturedAt   DateTime @default(now())

  connection Connection    @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  tables     SchemaTable[]

  @@index([connectionId, capturedAt])
}

model SchemaTable {
  id         String @id @default(cuid())
  snapshotId String
  tableName  String

  snapshot SchemaSnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)
  columns  SchemaColumn[]
  indexes  SchemaIndex[]

  @@index([snapshotId])
}

model SchemaColumn {
  id         String  @id @default(cuid())
  tableId    String
  columnName String
  dataType   String
  isNullable Boolean

  table SchemaTable @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@index([tableId])
}

model SchemaIndex {
  id         String @id @default(cuid())
  tableId    String
  indexName  String
  definition String @db.Text

  table SchemaTable @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@index([tableId])
}
