# Crusor AI Agent Documentation

This document provides a comprehensive overview of the MeshAG application, intended for use by AI agents like Crusor. It covers the application's architecture, database schema, background jobs, and API routes.

## Application Overview

MeshAG is a web application designed to help users monitor and optimize their database performance. It allows users to connect to their databases (PostgreSQL or MySQL), and the application will automatically collect statistics, analyze slow queries, and provide optimization suggestions using an LLM.

### Technology Stack

-   **Framework:** [Next.js](https://nextjs.org/) (App Router)
-   **Database:** PostgreSQL
-   **ORM:** [Prisma](https://www.prisma.io/)
-   **Background Jobs:** [Workflow](https://useworkflow.dev/) (Durable Execution)
-   **Authentication:** [Clerk](https://clerk.com/)
-   **Styling:** Mantine UI

### Project Structure

The project is a monorepo-style Next.js application with the following key directories:

-   `app/`: Contains the frontend pages and API routes.
    -   `app/(dashboard)/`: Protected routes for the user dashboard.
    -   `app/api/`: API endpoints for managing connections, suggestions, and workflows.
    -   `app/workflows/`: Workflow definitions (`syncDatabaseStats`, `generateSuggestions`).
-   `lib/`: Shared libraries and utilities, including database connectors, encryption, and the Prisma client.
-   `prisma/`: Prisma schema and migration files.

## Database Schema

The database schema is defined in `prisma/schema.prisma` using Prisma. It includes models for users, database connections, query statistics, and optimization suggestions.

### Enums

-   `DbType`: `POSTGRES` or `MYSQL`.
-   `ConnectionStatus`: `ACTIVE`, `INACTIVE`, `ERROR`, `TESTING`.
-   `SuggestionType`: `INDEX_OPTIMIZATION`, `QUERY_OPTIMIZATION`, `SCHEMA_OPTIMIZATION`, `CONNECTION_OPTIMIZATION`.
-   `SuggestionPriority`: `HIGH`, `MEDIUM`, `LOW`.
-   `SuggestionStatus`: `NEW`, `REVIEWED`, `APPLIED`, `DISMISSED`.

### Models

-   **User**: Represents an application user.
    -   `id`: Unique identifier from Clerk.
    -   `email`: User's email.
-   **Connection**: Stores user's database connection details.
    -   `encryptedPassword` and `encryptionKeyId` are used for securing credentials.
    -   `status`: The current state of the connection.
-   **Query**: Represents a unique query captured from a connection.
    -   `queryHash`: A hash of the query text to identify unique queries.
-   **QueryStats**: Time-series data for query execution statistics.
-   **QueryPlan**: Stores the query execution plan for a query.
-   **TableAccessPattern**: Tracks how frequently tables are accessed.
-   **IndexUsage**: Tracks the usage of database indexes.
-   **OptimizationSuggestion**: Stores optimization suggestions generated by the LLM.
-   **SchemaSnapshot**: A point-in-time snapshot of the database schema.
-   **SchemaTable**, **SchemaColumn**, **SchemaIndex**: Detailed schema information for each snapshot.

## Workflows

The application uses `workflow` (useworkflow.dev) for durable background jobs.

### Workflows

-   **`syncDatabaseStats(connectionId: string)`**:
    -   Orchestrates the process of fetching and saving database performance metrics.
    -   Ensures the connection is active.
    -   Handles errors by updating the connection status to `ERROR`.
-   **`generateSuggestions(connectionId: string)`**:
    -   Generates optimization suggestions for a connection.
    -   Fetches slow queries, index usage, and table access patterns.
    -   Calls an LLM (`gpt-4`) to generate suggestions.
    -   Saves the suggestions to the database.

## API Routes

The application exposes several API routes for managing resources and triggering workflows.

-   **`app/api/analytics/**`**: Routes for fetching analytics data for a connection.
    -   `[id]/indexes`: Get index usage data.
    -   `[id]/queries`: Get query statistics.
    -   `[id]/slow-queries`: Get slow queries.
    -   `[id]/tables`: Get table access patterns.
-   **`app/api/connections/**`**: Routes for managing database connections.
    -   `/`: `GET` connections, `POST` to create a new connection.
    -   `/[id]`: `GET`, `PUT`, `DELETE` a specific connection.
    -   `/[id]/sync`: `POST` to trigger the `syncDatabaseStats` workflow.
    -   `/[id]/test`: `POST` to test a database connection.
    -   `/test`: `POST` to test a new database connection before saving.
-   **`app/api/suggestions/**`**: Routes for managing optimization suggestions.
    -   `/[id]`: `GET`, `PUT` a specific suggestion.
    -   `/[id]/generate`: `POST` to trigger the `generateSuggestions` workflow.
-   **`app/api/webhooks/clerk`**: `POST` route for handling Clerk webhooks to sync user data.
