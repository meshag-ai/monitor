# Crusor AI Agent Documentation

This document provides a comprehensive overview of the Plotweft application, intended for use by AI agents like Crusor. It covers the application's architecture, database schema, background jobs, and API routes.

## Application Overview

Plotweft is a web application designed to help users monitor and optimize their database performance. It allows users to connect to their databases (PostgreSQL or MySQL), and the application will automatically collect statistics, analyze slow queries, and provide optimization suggestions using an LLM.

### Technology Stack

-   **Framework:** [Next.js](https://nextjs.org/) (App Router)
-   **Database:** PostgreSQL
-   **ORM:** [Prisma](https://www.prisma.io/)
-   **Background Jobs:** [Temporal.io](https://temporal.io/)
-   **Authentication:** [Clerk](https://clerk.com/)
-   **Styling:** [Tailwind CSS](https://tailwindcss.com/) (based on `globals.css`)

### Project Structure

The project is a monorepo-style Next.js application with the following key directories:

-   `app/`: Contains the frontend pages and API routes.
    -   `app/(dashboard)/`: Protected routes for the user dashboard.
    -   `app/api/`: API endpoints for managing connections, suggestions, and workflows.
-   `lib/`: Shared libraries and utilities, including database connectors, encryption, and the Prisma client.
-   `prisma/`: Prisma schema and migration files.
-   `temporal/`: Temporal workflow and activity definitions, along with the worker setup.

## Database Schema

The database schema is defined in `prisma/schema.prisma` using Prisma. It includes models for users, database connections, query statistics, and optimization suggestions.

### Enums

-   `DbType`: `POSTGRES` or `MYSQL`.
-   `ConnectionStatus`: `ACTIVE`, `INACTIVE`, `ERROR`, `TESTING`.
-   `SuggestionType`: `INDEX_OPTIMIZATION`, `QUERY_OPTIMIZATION`, `SCHEMA_OPTIMIZATION`, `CONNECTION_OPTIMIZATION`.
-   `SuggestionPriority`: `HIGH`, `MEDIUM`, `LOW`.
-   `SuggestionStatus`: `NEW`, `REVIEWED`, `APPLIED`, `DISMISSED`.

### Models

-   **User**: Represents an application user.
    -   `id`: Unique identifier from Clerk.
    -   `email`: User's email.
-   **Connection**: Stores user's database connection details.
    -   `encryptedPassword` and `encryptionKeyId` are used for securing credentials.
    -   `status`: The current state of the connection.
-   **Query**: Represents a unique query captured from a connection.
    -   `queryHash`: A hash of the query text to identify unique queries.
-   **QueryStats**: Time-series data for query execution statistics.
-   **QueryPlan**: Stores the query execution plan for a query.
-   **TableAccessPattern**: Tracks how frequently tables are accessed.
-   **IndexUsage**: Tracks the usage of database indexes.
-   **OptimizationSuggestion**: Stores optimization suggestions generated by the LLM.
-   **SchemaSnapshot**: A point-in-time snapshot of the database schema.
-   **SchemaTable**, **SchemaColumn**, **SchemaIndex**: Detailed schema information for each snapshot.

## Temporal Workflows & Activities

The application uses Temporal.io to run background jobs for syncing database statistics and generating optimization suggestions.

### Workflows

-   **`syncDatabaseStats(connectionId: string)`**:
    -   This workflow orchestrates the process of fetching and saving database performance metrics for a given connection.
    -   It ensures that the connection is active before proceeding.
    -   Handles errors by updating the connection status to `ERROR`.
-   **`generateSuggestions(connectionId: string)`**:
    -   This workflow generates optimization suggestions for a connection.
    -   It fetches slow queries, index usage, and table access patterns.
    -   It then calls an LLM (`gpt-4`) to generate suggestions based on the collected metrics.
    -   Finally, it saves the suggestions to the database.

### Activities

-   **`getConnection(connectionId: string)`**: Retrieves a connection from the database.
-   **`fetchDatabaseStats(...)`**: Connects to the user's database (Postgres or MySQL) and fetches query stats, schema, table patterns, and index usage.
-   **`saveDatabaseStats(connectionId: string, stats: ...)`**: Saves the fetched database stats to the application's database in a single transaction.
-   **`updateConnectionStatus(connectionId: string, status: ...)`**: Updates the status of a database connection.
-   **`fetchSlowQueries(connectionId: string)`**: Fetches slow queries for a connection from the local database.
-   **`fetchIndexUsage(connectionId: string)`**: Fetches index usage data.
-   **`fetchTablePatterns(connectionId: string)`**: Fetches table access pattern data.
-   **`generateLLMSuggestions(context: any)`**: Sends the collected metrics to the OpenAI API to generate suggestions.
-   **`saveSuggestions(connectionId: string, userId: string, suggestions: any[])`**: Saves the generated suggestions to the database.

## API Routes

The application exposes several API routes for managing resources and triggering workflows.

-   **`app/api/analytics/**`**: Routes for fetching analytics data for a connection.
    -   `[id]/indexes`: Get index usage data.
    -   `[id]/queries`: Get query statistics.
    -   `[id]/slow-queries`: Get slow queries.
    -   `[id]/tables`: Get table access patterns.
-   **`app/api/connections/**`**: Routes for managing database connections.
    -   `/`: `GET` connections, `POST` to create a new connection.
    -   `/[id]`: `GET`, `PUT`, `DELETE` a specific connection.
    -   `/[id]/sync`: `POST` to trigger the `syncDatabaseStats` workflow.
    -   `/[id]/test`: `POST` to test a database connection.
    -   `/test`: `POST` to test a new database connection before saving.
-   **`app/api/suggestions/**`**: Routes for managing optimization suggestions.
    -   `/[id]`: `GET`, `PUT` a specific suggestion.
    -   `/[id]/generate`: `POST` to trigger the `generateSuggestions` workflow.
-   **`app/api/webhooks/clerk`**: `POST` route for handling Clerk webhooks to sync user data.
-   **`app/api/workflows/**`**: Routes for triggering Temporal workflows.
    -   `/suggestions`: `POST` to trigger the `generateSuggestions` workflow.
    -   `/sync`: `POST` to trigger the `syncDatabaseStats` workflow.
